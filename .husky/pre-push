#!/bin/sh

# Pre-push hook to ensure code quality before pushing to remote
echo "ğŸš€ Running pre-push checks..."

# Check if we're pushing a tag (release)
if git diff --cached --name-only --diff-filter=A | grep -q "^v[0-9]"; then
  echo "ğŸ“¦ Detected release tag. Running full validation and tests..."
fi

# Run full validation
echo "ğŸ”§ Running validation (lint, format, type-check)..."
yarn validate
if [ $? -ne 0 ]; then
  echo "âŒ Validation failed. Please fix errors before pushing."
  exit 1
fi

# Run all tests
echo "ğŸ§ª Running all tests (314 tests)..."
yarn test:all
if [ $? -ne 0 ]; then
  echo "âŒ Tests failed. Please fix failing tests before pushing."
  exit 1
fi

# Run coverage to ensure it's generated
echo "ğŸ“Š Generating coverage report..."
yarn test:coverage:ci
if [ $? -ne 0 ]; then
  echo "âš ï¸  Coverage generation failed, but continuing..."
fi

echo "âœ… All pre-push checks passed! Ready to push."